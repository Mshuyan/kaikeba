# nacos

+ 客户端定时从注册中心拉取信息，并缓存到本地，即使注册中心死掉了，也不影响服务服务调用

## 配置中心原理

### SpringCloudConfig

![image-20210104002317403](assets/image-20210104002317403.png) 

+ 提交配置触发post请求给server端的bus/refresh接口
+  server端接收到请求并发送给Spring Cloud Bus总线
+ Spring Cloud bus接到消息并通知给其它连接到总线的客户端
+ 其它客户端接收到通知，请求Server端获取最新配置
+ 全部客户端均获取到最新的配置

### NacosConfig

![image-20210104002429824](assets/image-20210104002429824.png) 

+ 客户端长轮询获取配置
+ 服务端
  + 每30s检查以下配置是否发生变化，如果有变化立即返回
  + 事件订阅方式保证数据发生变化立马返回给客户端

## CAP

+ 解释

  + C
    + 数据一致性
  + A
    + 可用性
    + 整个服务对外一直可用
  + P
    + 分区容错性
    + 各个分区存在通信失败问题
    + 这个问题一定存在，所以只能在`CP`和`AP`之间进行选择
    + C和A不可兼得是因为P的存在

+ nacos默认是AP的，可以发送请求修改为`CP`

  ```
  http://localhost:8848/nacos/v1/ns/operator/switches?entry=ServerMode&value=CP
  ```

+ `zookeeper`是`CP`的

## BASE理论

+ 解释
  + BA
    + 基本可用
    + 出现分区问题时，允许损失部分可用性
  + S
    + 软状态
    + 允许数据同步过程中存在中间状态
  + E
    + 最终一致性
+ `BASE`理论是对`CAP`定理的补充
+ 最重要的是**最终一致性**，只要保证了`最终一致性`，允许损失部分可用性，也允许数据存在中间状态

## RAFT算法

+ `raft`算法是`paxos`算法简化版

+ 用于领导者选举

### 概念

+ Leader：领导者，可以处理读写请求，向其他节点同步数据日志
+ Candidate：候选人节点，参与leader选举的节点
+ Follower：从节点
  + 可以处理读请求，需要处理主节点同步过来的数据日志
  + 可以称为候选人节点
  + 可以进行投票
+ Term：任期
  + 发起依次选举任期加1
  + 表示第几次选举

### 流程

![image-20210104013110709](assets/image-20210104013110709.png) 

+ 当从节点心跳超时，